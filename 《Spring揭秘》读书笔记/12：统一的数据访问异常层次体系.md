<h1>统一的数据访问异常层次体系</h1>

> 《Spring揭秘》读书笔记

- [DAO 模式的背景](#dao-模式的背景)
- [数据访问机制的异常处理](#数据访问机制的异常处理)
- [Spring 异常层次体系](#spring-异常层次体系)

# DAO 模式的背景

为了简化和统一相关的数据访问操作，J2EE 核心模式提出了 DAO（Data Access Object）模式。使用 DAO 模式，可以完全分离数据的访问和存储，很好地屏蔽了各种数据访问方式的差异性。不论数据存储在普通文本文件或者还是关系型数据库系统中，使用 DAO 模式访问数据的客户端代码可以完全忽视这种差异，而以统一的接口来访问相应数据。

对于客户端代码来说，如通常的服务层代码，只需要声明依赖该数据访问接口即可，所有的数据访问全部通过该接口进行。即使以后因为数据存储机制发生变化，而导致 DAO 接口的实现类发生变化，客户端代码也不需要做任何的调整。

基于此，DAO 模式对屏蔽不同数据访问机制的差异起到举足轻重的作用。

# 数据访问机制的异常处理

不管是使用 JDBC 进行数据访问还是其他方式，都避免不了异常的处理。但是对于业务来说，不同的 Service 可能会调用相同的 DAO，在不同的 Service 中处理异常的逻辑也可能不同，显然需要将异常向上抛出，交给 Service 处理。但这又会带来另外的问题：如果换了其他数据存储系统，那么对应接口的异常肯定也会有所不同。

我们的数据访问接口对于客户端来说是通用的，不管数据访问对象因为数据访问机制的不同而加何变更，客户端代码不应该受其牵连。但是，比如使用 JDBC 做数据访问，需要抛出特定的 SQLException，那么客户端代码就需要捕捉该异常并做相应的处理。这是与数据访问对象模式的设计初衷相背离的。

既然直接在 DAO 实现类内部处理异常这条路走不通，将异常往外抛出又不可行，那么将数据访问异常进行封装后再抛出或许可以一试，往外抛出的是异常的门面，内里才是对应的异常。如果要这么做，以什么类型的异常进行封装然后再抛出去呢？是抛出受检异常还是未受检异常呢？

大部分的或者是说所有的数据访问操作抛出的异常对于客户端来说是系统的 Fault，客户端是无法有效处理的，所以，将 SQLException 以及其他特定于数据访问机制的异常，以未受检异常进行封装然后抛出，是比较合适的。

这样一来，虽然解决了统一数据访问接口的问题，但是，该方案依然不够周全。以 SQLException 为例，各个数据库提供商通过 SQLException 表达具体的错误信息时，所采用的方式是不同的，比如，有的数据库提供商采用 SQLException 的 ErrorCode 作为具体的错误信息标准，有的数据库提供商则通过 SQLException 的 SqlState来返回详细的错误信息。即使将 SQLException 封装后抛出给客户端对象，当客户端对象需要了解具体的错误信息时，依然需要根据数据库提供商的不同，采取不同的信息提取方式。这个工作如果由 DAO 的客户端来完成，那就太繁琐了。

于是，还需要对异常进行分类，比如，数据库连不上、服务器连接失败，我们认为它们同属于获取资源失败；而主键冲突或者其他资源冲突，我们认为它们属于数据一致性冲突。

# Spring 异常层次体系

Spring 框架中统一的异常层次体系所涉及的大部分异常类型都定义在 `org.springframework.dao` 包中，处于这个体系的所有异常类型均以 `org.springframework.dao.DataAccessException` 为 “统领”，如下：

- **CleanupFailureDataAccessException：** 当已经成功完成相应的数据访问操作，要对使用的资源进行清理却失败的时候，将抛出该异常。
- **DataAccessResourceFailureException：** 在无法访问相应的数据资源的情况下，将抛出该异常，常见于数据库服务器宕机的情况。
- **DataSourceLookupFailureException：** 尝试对 JNDI（Java Naming and Directory Interface，Java 命令和服务接口）服务上或者其他位置上的 DataSource 进行查找，查找失败时将抛出该异常。
- **ConcurrencyFailureException：** 并发进行数据访问操作失败的时候，将抛出该异常，比如无法取得相应的数据库锁，或者乐观锁更新冲突等情况。
- **InvalidDataAccessApiUsageException：** 数据访问 API 调用错误，比如，使用 Spring 的 JdbcTemplate 的 getForObject 方法进行查询操作，而传入的 SQL 查询却返回多行结果，就会抛出该异常。
- **InvalidDataAccessResourceUsageException：** 以错误的方式访问数据资源，将抛出该异常。
- **DataRetrievalFailureException：** 要获取预期数据却失败的时候，将抛出该异常，比如某位顾客存在，但是我们要根据客户号获取顾客信息却失败的时候，将抛出该异常。
- **PermissionDeniedDataAccessException：** 尝试访问某些数据，而自身却没有相应权限的情况下，将抛出该异常。
- **DataIntegrityViolationException：** 数据一致性冲突异常，是在我们尝试更新数据却违反了数据一致性检查的情况下，将会抛出该异常。
- **UncategorizedDataAccessException：** 出现其他无法详细分类的数据访问异常，可以抛出该异常。该异常定义为 abstract，如果对于特定的数据访问方式来说，以上的异常类型无法描述当前数据访问方式中特定的异常情况，那么可以通过扩展 UncategorizedDataAccessException 来进一步细化特定的数据访问异常类型。