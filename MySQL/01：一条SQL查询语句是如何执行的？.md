[toc]

> [《极客时间-MySQL实战45讲》01 | 基础架构：一条SQL查询语句是如何执行的？](https://time.geekbang.org/column/intro/100020801)，笔记整理

# MySQL 架构示意图

![MySQL逻辑架构图](https://wrp-blog-image.oss-cn-beijing.aliyuncs.com/blog-images/MySQL逻辑架构图.jpg)

MySQL架构上从大体来说可以分为Server层和存储引擎层两个部分。

**Server层：** 包括连接器、查询缓存、分析器、优化器、执行器等，其中涵盖了MySQL的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有的跨存储引擎的功能也都在这一层实现，比如存储过程、触发器、视图等。

**存储引擎层：** 负责数据的存储和读取。其架构模式是插件式的，支持InnoDB、MyISAM、Menory等多个存储引擎。现在最常用的存储引擎是InnoDB，InnoDB从MySQL 5.5.5版本开始成为默认存储引擎。

# 连接器

> 连接器负责跟客户端建立连接、获取权限、维持和管理连接。

如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。**之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。**但是这就意味着，一个用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。<u>修改完成后，只有再新建的连接才会使用新的权限设置。</u>

由于 <u>MySQL 在执行过程中临时使用的内存是管理在连接对象里面的</u>。所以一旦一个连接使用时间过长，执行的操作越多，其所占用的内存也越大，而这些内存资源只有在连接被断开的时候才会被释放。一旦内存占用过大，就有可能会被系统强行杀掉，从现象上来看就是MySQL的异常重启。解决这个问题的方法一般有以下两种：
1. **定期断开长连接。**使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。
2. 如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，**通过执行mysql_reset_connection来重新初始化连接资源。**这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。

# 查询缓存

执行过的语句及其结果可能会以 key-value 对的形式，被直接缓存在内存中。key 是查询的语句，value 是查询的结果。

大多数情况下建议不要使用查询缓存，为什么呢？因为**查询缓存往往弊大于利！**

查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。这对于经常更新的表来说，查询缓存的命中率会非常低。除非是一些静态表，例如系统配置表之类的。

MySQL 也提供了显示指定是否使用缓存的方式：将参数 query_cache_type 设置成 DEMAND，这样对于默认的 SQL 语句都不使用查询缓存。而对于确定要使用查询缓存的语句，可以用 SQL_CACHE 显式指定，像下面这样：

```sql
mysql> select SQL_CACHE * from T where ID=10；
```

# 分析器
对于SQL语句做词法分析、语法分析。

- **词法分析：**分析SQL语句中的每个单词代表什么意思
- **语法分析：**分析SQL语句是否满足MySQL的语法要求

# 优化器
- 决定使用索引的方式
- 如果是多表连接查询还需要决定表连接的先后顺序

# 执行器

**执行流程（没索引）：**

1. 调用 InnoDB 引擎接口取这个满足条件的第一行。
2. 调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。
3. 执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。

在数据库的慢查询日志中有一个 rows_examined 的字段，表示这个语句执行过程中扫描了多少行。这个值就是在执行器每次调用引擎获取数据行的时候累加的。

但是在有些场景下，执行器调用一次，在引擎内部则扫描了多行，因此引擎扫描行数跟 rows_examined 并不是完全相同的。

---

实际上在连接器、分析器、执行器阶段都是会做权限的校验的，因此把权限校验的这一块内容放在最后一起说明：

**连接器的权限校验：**应该是库的校验，因为连接是可以指定连接到哪个库中去的，不指定库的话连接成功之后也是要返回可以操作的库给用户的。

**分析器的权限校验：**在分析器应该是做的表权限验证，因为分析器已经分析出要执行的SQL了需要调用那一张表了，在此处进行表的权限验证就是最合适的。

**执行器的权限校验：**在执行器这一块我认为是做的一个存储过程、触发器、函数之类的验证，因为在这些模块中是可能会调用到其他的表的，而在分析器的时候并不知道这些模块都调用到什么表，因此MySQL需要判断当前用户是否有对这些模块所调用到的表的权限。

--- 

> 网友热心总结的一些问题，复习的时候可以试着回答一下。

1. Server 有多少组件，各自都是什么作用？
2. Server 层和存储引擎层各是什么作用？
3. `you have an error in your SQL syntax` 这个错误是在词法分析还是语法分析的报错？
4. 对于表的操作权限验证在哪里进行？
5. 执行器执行查询语句的流程是怎么样的？

大家加油：）