<h1>Docker 数据卷</h1>

> 《掘金小册-开发者必备的 Docker 实践指南》学习笔记

数据管理使用挂载的方式，通过数据卷可以方便管理挂载的目录

# 容器数据管理

容器内的文件系统是随着容器的生命周期而创建和移除的，容器内部的数据无法被持久化存储。由于容器隔离，操作容器内部文件也变得很麻烦。Docker 解决这一问题的方式是文件挂载，将宿主操作系统中的文件挂载到容器内部，便可以让容器内外都共享这个文件。通过这种方式可以互通容器内外的文件，那么文件数据持久化以及操作容器内部文件的问题也就得到了解决。

Docker 提供了三种文件挂载的方式：Bind Mount、Volume 和 Tmpfs Mount。

![docker文件挂载](https://wrp-blog-image.oss-cn-beijing.aliyuncs.com/blog-images/docker文件挂载.png)

- **Bind Mount：** 直接将宿主操作系统中的目录和文件挂载到容器内的文件系统中，形成挂载映射关系，在容器内外对文件的读写都相互可见。
    > 使用 `-v` 参数设置，示例：`-v <host-path>:<container-path>:ro`，ro（可选）表示容器内只读。为避免混淆，此处强制使用绝对路径。

- **Volume（数据卷）：** 仅指定容器内的目录，宿主操作系统挂载的目录由 Docker 进行管理，不需要关心具体挂载到了宿主操作系统中的哪里。
    > Bind Mount 模式为指定 `<host-path>` 则为 Volume。此种方式生成的数据在路径上会有 Docker 生成的 ID，所以能够自己命名：`-v name:<container-path>`

- **Tmpfs Mount：** 挂载系统内存中的一部分到容器的文件系统里，不过由于内存和容器的特征，它的存储并不是持久的，其中的内容会随着容器的停止而消失。
    > 使用 `--tmpfs` 参数挂载，`--tmpfs <host-path>`

以上创建出来的数据挂载信息，或者是数据卷信息可以通过 `docker inspect` 命令查看。

# 数据卷管理

上面对数据卷的操作都是基于容器的，多少有点不方便，Docker 提供了独立操作数据卷的方式。

**数据卷使用命令：**

| 操作 | 命令| 
| :-- | :-- |
| 创建数据卷 | `docker volume create volume-name` |
| 查看数据卷 | `docker volume ls` |
| 删除数据卷 | `docker volume rm volume-name` |
| 删除没有被引用且未命名的数据卷 | `docker volume prune -f` |

**数据卷容器：**

创建数据卷容器的方式很简单，由于不需要容器本身运行，因而我们找个简单的系统镜像都可以完成创建。

```
docker create --name appdata -v /webapp/storage ubuntu
```

在使用数据卷容器时，我们不建议再定义数据卷的名称，因为我们可以通过对数据卷容器的引用来完成数据卷的引用。之前我们提到，Docker 的 Network 是容器间的网络桥梁，如果做类比，数据卷容器就可以算是容器间的文件系统桥梁。我们可以像加入网络一样引用数据卷容器，只需要在创建新容器时使用专门的 `--volumes-from` 选项即可。

```
docker run -d --name nginx --volumes-from appdata nginx
```

引用数据卷容器时，不需要再定义数据卷挂载到容器中的位置，Docker 会以数据卷容器中的挂载定义将数据卷挂载到引用的容器中。

使用数据卷容器看起来与使用原始数据卷的方式差不多，但是数据卷容器主要是在迁移数据卷时提供方便。如果迁移数据卷至其他目录，不用修改引用容器中的数据卷，数据卷容器相当于对数据卷的路径做了一层包装或者是取了个别名的意思。
