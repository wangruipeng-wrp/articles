---
title: JavaScript：闭包
abbrlink: 47023
date: 2020-06-09 19:06:46
copyright: false
completed: false
categories:
 - JavaScript
---
闭包：**「函数」和「函数内部能访问到的变量」（也叫环境）的总和，就是一个闭包。**
闭包在js面向对象中是一个非常重要的知识点，许多的面向对象的特性都可以通过闭包来体现。
<!-- more -->

# 什么是闭包
```js
!function() {
    var local = '变量'
    function foo() {
        console.log(local)
    }
}
```
在上面函数内部的三行代码中，有一个局部变量 `local`，有一个函数 `foo` ，`foo` 里面可以访问到 `local` 变量。这就是一个闭包，就是这么简单。

其实大家比较熟知的闭包是下面的这种嵌套函数的形式：
```js
function foo(){
  var local = 1
  function bar(){
    local++
    return local
  }
  return bar
}

var func = foo()
func()
```
这里面呢确实有闭包的存在，`local` 变量和 `bar` 函数就组成了一个闭包。

**那么为什么要嵌套函数呢？**

是因为需要局部变量，所以才把 `local` 放在一个函数里，如果不把 `local` 放在一个函数里，`local` 就是一个全局变量了，达不到使用闭包的目的——隐藏变量（等会会讲）。

可能看到「闭包」这个名字，就一定觉得要用什么包起来才行。其实这是翻译问题，闭包的原文是 Closure，跟「包」没有任何关系。

所以函数套函数只是为了造出一个局部变量，**跟闭包无关**。

**为什么要 return bar 呢？**

因为如果不 `return`，你就无法使用这个闭包。把 `return bar` 改成 `window.bar = bar` 也是一样的，只要让外面可以访问到这个 `bar` 函数就行了。

所以 `return bar` 只是为了 `bar` 能被使用，也**跟闭包无关**。

---

# 闭包的作用

闭包常常用来「间接访问一个变量」。换句话说，「隐藏一个变量」。

假设我们现在在做一个系统的注册登录功能，在写其中关于「用户年龄」的代码。

如果不使用闭包的话
```js
window.age = 18 // 18岁
```

但是这么看起来是非常危险的，因为这将在全局的任何一个地方都可以直接的访问到这个 `age` 变量，如果不加校验的话，等会要是被修改成 「负数」 怎么办，对吧？

所以，我们不能让别人可以「直接访问」这个 `age` 变量。

我们需要使用「局部变量」

但是使用了局部变量的话，这个变量的又需要一个全局的作用域。这个时候应该怎么办？

我们可以主动暴露一个访问器（函数），让别人可以「间接访问」

> 上面的思考过程其实也就是 闭包 使用函数嵌套形式的由来。

代码如下：
```js
!function() {

    var age = 18;

    // 修改年龄，增加1岁
    window.addAge = function() {
        age += 1;
    }

    // 修改年龄，减少1岁
    window.subLives = function() {
        if (age > 1) {
            lives -= 1;
        } else {
            console.log('没办法再往下修改年龄啦');
        }
    }
}()
```

上面这也是一个闭包的例子。使用闭包之后可以更加规范的去管理我们的变量，这也是闭包的意义。总的来说这就是闭包，闭包也仅此而已。

---

其实写到这里之后，可能由于我是学 Java 出身的，立马就想到了 Java 中实体类的封装。来看一段 Java 代码
```java
class student{

    private int age;

    public int getAge() {
        return this.age;
    }

    public void setAge(int age) {
        if (age >= 1) {
            this.age = age;
        } else {
            System.out.println("年龄必须为正数");
        }
    }
}
```
简要说明一下上面这段代码：
首先声明一个私有化的 `age` 变量，然后为这个变量提供公有的 `get` 和 `set` 方法，可以让外界访问到这个 `age` 变量。当我们设置这个 `age` 变量的时候，我们可以在 `set` 方法中去定义一些规范，保证 `age` 值的一个正确性。

在我看来，刚刚的闭包的例子与上面的这段 Java 代码实现的是同一个功能。也就是说闭包其实是为了封装变量，只是在这里我们将其称为了隐藏变量，仅此而已。

> 参考文章：
> [「每日一题」JS 中的闭包是什么？](https://zhuanlan.zhihu.com/p/22486908)

---

> 分享一个小经验：
编程崇尚的是以简洁优雅为美，<font color=blue>很多时候如果你觉得一个概念很复杂，那么很可能是你理解错了</font>

大家加油：）